<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thi trắc nghiệm Điều lệnh CAND 2025 — 20 câu (hiển thị từng câu)</title>
  <style>
    :root { --w: 900px; }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.5;margin:0;background:#f7fafc;color:#222}
    header{background:#0d6efd;color:#fff;padding:16px}
    header h1{margin:0;font-size:20px}
    main{max-width:var(--w);margin:20px auto;padding:0 12px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.05);padding:18px;margin-bottom:16px}
    .muted{color:#6b7280;font-size:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > * {flex:1}
    button{border:0;background:#0d6efd;color:#fff;padding:12px 16px;border-radius:10px;font-weight:600;cursor:pointer}
    button.secondary{background:#6b7280}
    button.ghost{background:#eef2ff;color:#1f2937}
    button:disabled{opacity:.6;cursor:not-allowed}
    .choices{margin-top:8px}
    .choice{display:flex;gap:10px;padding:10px;border:1px solid #e5e7eb;border-radius:10px;margin-bottom:8px;cursor:pointer}
    .choice input{margin-top:3px}
    .choice.correct{border-color:#16a34a;background:#ecfdf5}
    .choice.wrong{border-color:#dc2626;background:#fef2f2}
    .pill{display:inline-block;background:#eef2ff;color:#1f2937;border-radius:999px;padding:2px 10px;font-size:12px;margin-left:8px}
    .score{font-size:20px;font-weight:700}
    .center{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    @media (max-width:600px){header h1{font-size:18px}}
  </style>
</head>
<body>
  <header>
    <h1>Thi trắc nghiệm Điều lệnh, Quân sự, Võ thuật CAND 2025 <span class="pill">20 câu — hiển thị từng câu</span></h1>
  </header>

  <main>
    <div class="card">
      <p class="muted">Mỗi lượt thi hệ thống bốc ngẫu nhiên 20 câu từ <code>questions.json</code>, trộn thứ tự đáp án. Bạn trả lời từng câu, bấm <b>Nộp đáp án</b> để chấm, rồi <b>Câu kế tiếp</b> để sang câu tiếp theo.</p>
      <div class="row">
        <button id="btnStart">Bắt đầu làm bài</button>
        <button id="btnRetake" class="secondary" style="display:none">Làm lại (bốc 20 câu mới)</button>
      </div>
    </div>

    <div id="quizBox" class="card" style="display:none">
      <div class="center">
        <div id="progress" class="muted">Câu 1/20</div>
        <div id="scoreMini" class="muted">Đúng: 0</div>
      </div>
      <div id="qText" style="font-weight:600;margin:8px 0 10px"></div>
      <div id="choices" class="choices"></div>
      <div class="row">
        <button id="btnSubmit" class="ghost">Nộp đáp án</button>
        <button id="btnNext" disabled>Câu kế tiếp</button>
      </div>
    </div>

    <div id="result" class="card" style="display:none"></div>
  </main>

  <script>
    // --- Utilities ---
    const rngShuffle = arr => {
      // Fisher–Yates
      const a = arr.slice();
      for (let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    };
    const pickN = (arr, n) => rngShuffle(arr).slice(0, n);

    // --- Elements ---
    const btnStart = document.getElementById('btnStart');
    const btnRetake = document.getElementById('btnRetake');
    const quizBox = document.getElementById('quizBox');
    const qTextEl = document.getElementById('qText');
    const choicesEl = document.getElementById('choices');
    const btnSubmit = document.getElementById('btnSubmit');
    const btnNext = document.getElementById('btnNext');
    const progressEl = document.getElementById('progress');
    const scoreMiniEl = document.getElementById('scoreMini');
    const resultBox = document.getElementById('result');

    // --- State ---
    let bank = [];       // full bank from questions.json
    let keyMap = {};     // optional extra keys from answer_key.json
    let quiz = [];       // 20 selected questions
    let current = 0;     // index of current question
    let score = 0;       // correct count
    let answers = [];    // [{id, chosen, correct}]
    let locked = false;  // whether current question is already graded

    // Load data; if some questions lack "answer", try answer_key.json
    async function loadData() {
      const qRes = await fetch('questions.json?' + Date.now());
      if (!qRes.ok) throw new Error('Không tải được questions.json');
      bank = await qRes.json();

      if (bank.some(q => !q.answer)) {
        try {
          const kRes = await fetch('answer_key.json?' + Date.now());
          if (kRes.ok) keyMap = await kRes.json();
        } catch(e){}
      }
      bank.forEach(q => {
        if (!q.answer && keyMap[String(q.id)]) {
          q.answer = String(keyMap[String(q.id)]).trim().toUpperCase();
        }
      });
      // Filter out questions without answers (to đảm bảo chấm từng câu chuẩn)
      const hasKey = bank.filter(q => ['A','B','C'].includes((q.answer||'').toUpperCase()));
      if (hasKey.length < 20) {
        alert('Cần tối thiểu 20 câu có đáp án trong dữ liệu. Vui lòng bổ sung "answer" cho questions.json hoặc answer_key.json.');
        throw new Error('Not enough keyed questions');
      }
      bank = hasKey;
    }

    function startQuiz() {
      quiz = pickN(bank, 20).map(q => {
        // build choices array with mapping to original labels
        const options = [
          {label:'A', text:q.A},
          {label:'B', text:q.B},
          {label:'C', text:q.C},
        ];
        const shuffled = rngShuffle(options);
        return {
          id: q.id,
          text: q.text,
          choices: shuffled,   // [{label,text}]
          correct: q.answer    // 'A' | 'B' | 'C'
        };
      });
      current = 0;
      score = 0;
      answers = [];
      btnStart.style.display = 'none';
      btnRetake.style.display = 'inline-block';
      resultBox.style.display = 'none';
      quizBox.style.display = 'block';
      renderCurrent();
    }

    function renderCurrent() {
      locked = false;
      const q = quiz[current];
      progressEl.textContent = `Câu ${current+1}/${quiz.length} (Mã gốc: ${q.id})`;
      scoreMiniEl.textContent = `Đúng: ${score}`;
      qTextEl.textContent = q.text;
      choicesEl.innerHTML = '';
      btnSubmit.disabled = false;
      btnNext.disabled = true;

      q.choices.forEach((ch, idx) => {
        const wrap = document.createElement('label');
        wrap.className = 'choice';
        wrap.innerHTML = `
          <input type="radio" name="q" value="${ch.label}" style="margin-top:3px" />
          <div><b>${String.fromCharCode(65+idx)}.</b> ${ch.text}</div>
        `;
        wrap.addEventListener('click', (e) => {
          // clicking anywhere selects the radio
          const input = wrap.querySelector('input');
          if (!locked) input.checked = true;
        });
        choicesEl.appendChild(wrap);
      });
    }

    function gradeCurrent() {
      if (locked) return;
      const q = quiz[current];
      const checked = choicesEl.querySelector('input[name="q"]:checked');
      if (!checked) {
        alert('Vui lòng chọn một phương án trước khi nộp.');
        return;
      }
      const chosen = checked.value; // original label of that choice (A/B/C by source)
      const isCorrect = chosen === q.correct;

      // Colorize: find which rendered item corresponds to correct ORIGINAL label
      const wraps = [...choicesEl.querySelectorAll('.choice')];
      wraps.forEach((wrap, idx) => {
        const input = wrap.querySelector('input');
        const origLabel = q.choices[idx].label; // original label from bank
        if (origLabel === q.correct) wrap.classList.add('correct');
        if (input.checked && origLabel !== q.correct) wrap.classList.add('wrong');
        // disable click after submit
        input.disabled = true;
      });

      if (isCorrect) score++;
      scoreMiniEl.textContent = `Đúng: ${score}`;
      answers.push({ id: q.id, chosen, correct: q.correct });
      locked = true;
      btnSubmit.disabled = true;
      btnNext.disabled = false;
    }

    function nextQuestion() {
      if (!locked) return; // must submit first
      current++;
      if (current < quiz.length) {
        renderCurrent();
      } else {
        showSummary();
      }
    }

    function showSummary() {
      quizBox.style.display = 'none';
      resultBox.style.display = 'block';
      const pct = Math.round(score/quiz.length*100);
      resultBox.innerHTML = `
        <div class="score">Kết quả: ${score}/${quiz.length} (${pct}%)</div>
        <details style="margin-top:8px"><summary>Xem chi tiết từng câu</summary>
          <ol style="margin-top:8px">
            ${answers.map((a,i) => `<li>Câu ${i+1} (Mã ${quiz[i].id}): bạn chọn ${a.chosen}; đúng là ${a.correct}</li>`).join('')}
          </ol>
        </details>
        <div class="row" style="margin-top:12px">
          <button class="secondary" id="btnAgain">Làm lại (bốc 20 câu mới)</button>
        </div>
      `;
      document.getElementById('btnAgain').onclick = () => startQuiz();
    }

    // Events
    btnStart.onclick = async () => {
      try { await loadData(); startQuiz(); }
      catch(e){ console.error(e); }
    };
    btnRetake.onclick = () => startQuiz();
    btnSubmit.onclick = gradeCurrent;
    btnNext.onclick = nextQuestion;
  </script>
</body>
</html>
